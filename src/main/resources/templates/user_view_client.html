<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}">
  <link rel="stylesheet" type="text/css" th:href="@{/css/viewallstyle.css}">

  <title>Thinture GPS</title>
  <link rel="icon" type="image/x-icon" href="THINTURE_IMAGE/favicon.jpg">

  <style>


 
  </style>
</head>
<body>
	<!--<<<<< git conflict >>>>>-->
  <div th:insert="navigation_client :: navbar_client"></div>
  <div class="card">
  <h2>Users  Management</h2>
  <!-- ðŸ” Search Bar -->
      <div class="mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Search clients..." />
      </div>
	  <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
	    <span id="totalRecords" class="text-white fw-semibold">Total Users: 0</span>
	    <button class="btn btn-success btn-sm" onclick="exportToExcel()">
	      <i class="fas fa-file-excel me-1"></i> Export to Excel
	    </button>
	  </div>

    <div class="table-wrapper">
      <table id="userTable" class="table table-bordered table-hover table-dark">
        <thead>
          <tr>
            <th>ID</th>
            <th>Company Name</th>
            <th>Email</th>
            <th>Address</th>
            <th>Phone</th>
            <th>Country</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- User data will be loaded here -->
        </tbody>
      </table>
	  <div id="pagination" class="text-center mt-3"></div>

    </div>
  </h2>

  <script>
    const API_URL = "/api/users/user";
    const ROWS_PER_PAGE = 10;
    let currentPage = 1;
    let usersData = [];
    let filteredData = [];

    async function loadUsers() {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error("Failed to fetch user data");

        usersData = await response.json();
        filteredData = [...usersData]; // clone the original data for filtering
        renderTable();
      } catch (err) {
        alert("Error loading users: " + err.message);
        console.error(err);
      }
    }

	function renderTable() {
	  const tbody = document.querySelector("#userTable tbody");
	  const totalSpan = document.getElementById("totalRecords"); // âœ… count reference
	  tbody.innerHTML = "";

	  // âœ… Update total count
	  totalSpan.innerText = `Total Users: ${filteredData.length}`;

	  const startIndex = (currentPage - 1) * ROWS_PER_PAGE;
	  const endIndex = startIndex + ROWS_PER_PAGE;
	  const paginatedUsers = filteredData.slice(startIndex, endIndex);

	  paginatedUsers.forEach(user => {
	    const row = document.createElement("tr");
	    row.innerHTML = `
	      <td>${user.id}</td>
	      <td>${user.name}</td>
	      <td>${user.email}</td>
	      <td>${user.address}</td>
	      <td>${user.phone}</td>
	      <td>${user.country}</td>
	      <td>
	        <button class="btn btn-sm btn-primary me-1" onclick="editUser(${user.id})"><i class="fas fa-edit"></i></button>
	        <button class="btn btn-sm btn-danger me-1" onclick="deleteUser(${user.id})"><i class="fas fa-trash"></i></button>
	        <button class="btn btn-sm btn-warning" onclick="toggleStatus(this)"><i class="fas fa-user-lock"></i> Toggle</button>
	      </td>
	    `;
	    tbody.appendChild(row);
	  });

	  renderPagination();
	}

    function renderPagination() {
      const paginationContainer = document.getElementById("pagination");
      paginationContainer.innerHTML = "";

      const totalPages = Math.ceil(filteredData.length / ROWS_PER_PAGE);

      const prevBtn = document.createElement("button");
      prevBtn.innerText = "Previous";
      prevBtn.className = "btn btn-sm btn-light";
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      };
      paginationContainer.appendChild(prevBtn);

      const pageInfo = document.createElement("span");
      pageInfo.className = "mx-3 text-light align-self-center";
      pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
      paginationContainer.appendChild(pageInfo);

      const nextBtn = document.createElement("button");
      nextBtn.innerText = "Next";
      nextBtn.className = "btn btn-sm btn-light";
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderTable();
        }
      };
      paginationContainer.appendChild(nextBtn);
    }

    function editUser(id) {
      alert("Edit User: " + id);
    }

    function deleteUser(id) {
      Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it!',
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire('Deleted!', 'User has been deleted.', 'success');
        }
      });
    }

    function toggleStatus(button) {
      const isBlocked = button.classList.contains("btn-dark");
      if (isBlocked) {
        button.classList.remove("btn-dark");
        button.classList.add("btn-warning");
        button.innerHTML = '<i class="fas fa-user-lock"></i> Toggle';
      } else {
        button.classList.remove("btn-warning");
        button.classList.add("btn-dark");
        button.innerHTML = '<i class="fas fa-user-check"></i> Unblock';
      }
    }

    // ðŸ” Live Search
    document.addEventListener("input", function (e) {
      if (e.target.id === "searchInput") {
        const searchText = e.target.value.toLowerCase();

        filteredData = usersData.filter(user =>
          Object.values(user).some(value =>
            String(value).toLowerCase().includes(searchText)
          )
        );

        currentPage = 1;
        renderTable();
      }
    });
	function exportToExcel() {
	  const worksheet = XLSX.utils.json_to_sheet(filteredData);
	  const workbook = XLSX.utils.book_new();
	  XLSX.utils.book_append_sheet(workbook, worksheet, "Users");
	  XLSX.writeFile(workbook, "Users_List.xlsx");
	}

    window.onload = loadUsers;
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>