<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Limit Tracker</title>
    
    <!-- HERE Maps CSS -->
    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />
    
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        .header {
            background-color: #4285f4;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #f8f9fa;
        }
        
        #map-container {
            width: 100%;
            height: 70vh;
            background-color: #f2f2f2;
        }
        
        .coord-input {
            display: flex;
            padding: 10px;
            background-color: #f8f9fa;
            border-top: 1px solid #ddd;
        }
        
        .coord-input input {
            padding: 5px;
            margin-right: 5px;
            width: 120px;
        }
        
        button {
            padding: 8px 16px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        
        button:hover {
            background-color: #3367d6;
        }
        
        .speed-info {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 200px;
            display: none;
        }
        
        .speed-circle {
            border: 3px solid #c00;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .speed-limit {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        #error-message {
            background-color: #ffdddd;
            color: #cc0000;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .log-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 300px;
            max-height: 200px;
            overflow-y: auto;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .try-alternate {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .current-speed {
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .path-line {
            stroke: #4285f4;
            stroke-width: 4px;
            stroke-opacity: 0.7;
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    
    <div class="header">
        <h2>Speed Limit Tracker</h2>
    </div>
    
    <div class="controls">
        <div>
            <button id="locate-me">Locate Me</button>
            <button id="start-tracking">Start Tracking</button>
        </div>
        <div>
            <button id="show-traffic">Show Traffic</button>
            <button id="hide-traffic">Hide Traffic</button>
            <button id="toggle-logs">Show Logs</button>
        </div>
    </div>
    
    <div class="coord-input">
        <input type="text" id="latitude" placeholder="Latitude (e.g. 12.9716)">
        <input type="text" id="longitude" placeholder="Longitude (e.g. 77.5946)">
        <button id="get-speed-limit">Get Speed Limit</button>
    </div>
    
    <div id="error-message"></div>
    
    <div id="map-container"></div>
    
    <div class="speed-info" id="speed-info">
        <h3>Current Location</h3>
        <div id="location-info">Latitude: 0, Longitude: 0</div>
        
        <div class="speed-limit">
            <div class="speed-circle" id="speed-circle">--</div>
            <div>
                <div id="speed-limit-text">Speed Limit</div>
                <div id="road-name">Unknown Road</div>
                <div id="speed-note" style="font-size: 10px; color: #666;"></div>
            </div>
        </div>
        
        <div class="current-speed" id="current-speed-container" style="display: none;">
            <div><strong>Your Speed:</strong> <span id="current-speed">0</span> km/h</div>
            <div><strong>Direction:</strong> <span id="current-direction">N/A</span></div>
        </div>
        
        <div class="try-alternate" id="try-alternate" style="display: none;">
            Try alternate API method
        </div>
    </div>
    
    <div id="log-panel" class="log-panel">
        <h4>Activity Log</h4>
        <div id="log-entries"></div>
    </div>
    
    <!-- Load HERE Maps JavaScript APIs -->
    <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
    
    <script th:inline="javascript">
        // Get the HERE credentials from the backend
        const apiKey =  '19cJwlsY5xkdO13O_869LM29OScg30J1TCstjWfPSF8';
    </script>
    
    <script>
        // Logging system
        const logEntries = document.getElementById('log-entries');
        
        function addLogEntry(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const time = document.createElement('span');
            time.className = 'log-time';
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            time.textContent = `${timeStr} - `;
            
            const text = document.createElement('span');
            text.textContent = message;
            
            entry.appendChild(time);
            entry.appendChild(text);
            
            logEntries.appendChild(entry);
            logEntries.scrollTop = logEntries.scrollHeight;
            
            // Also log to console
            console.log(`${type.toUpperCase()}: ${message}`);
        }
        
        // Error handling
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            addLogEntry(message, 'error');
            
            // Hide error after 5 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Initialize map
        let map, platform, defaultLayers, positionMarker, trafficLayer, routeLine;
        let isTracking = false;
        let watchId = null;
        let currentLat = null;
        let currentLng = null;
        let previousPositions = [];
        let lastLocation = null;
        let lastTimestamp = null;
        
        // Map initialization with retry
        function initMapWithRetry(retryCount = 0, maxRetries = 3) {
            addLogEntry(`Initializing map (attempt ${retryCount + 1})...`);
            
            try {
                // Initialize HERE platform with API key
                platform = new H.service.Platform({
                    apikey: apiKey
                });
                
                // Get default map layers
                defaultLayers = platform.createDefaultLayers();
                
                // Initialize the map
                map = new H.Map(
                    document.getElementById('map-container'),
                    defaultLayers.vector.normal.map,
                    {
                        zoom: 14,
                        center: { lat: 12.9716, lng: 77.5946 } // Default to Bengaluru
                    }
                );
                
                // Make the map responsive
                window.addEventListener('resize', () => {
                    map.getViewPort().resize();
                });
                
                // Add map interaction
                const behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
                
                // Add UI components
                const ui = H.ui.UI.createDefault(map, defaultLayers);
                
                // Hide loading overlay
                document.getElementById('loading-overlay').style.display = 'none';
                
                addLogEntry('Map initialized successfully');
                
                // Set up map click handler
                setupMapClickHandler();
                
                // Auto-locate user after map loads
                setTimeout(() => {
                    document.getElementById('locate-me').click();
                }, 1000);
                
            } catch (e) {
                showError("Error initializing map: " + e.message);
                console.error("Map initialization error:", e);
                
                if (retryCount < maxRetries) {
                    addLogEntry(`Retrying map initialization in 1 second... (${retryCount + 1}/${maxRetries})`);
                    setTimeout(() => {
                        initMapWithRetry(retryCount + 1, maxRetries);
                    }, 1000);
                } else {
                    addLogEntry('Failed to initialize map after multiple attempts', 'error');
                    document.getElementById('loading-overlay').style.display = 'none';
                }
            }
        }
        
        function setupMapClickHandler() {
            if (map) {
                map.addEventListener('tap', function(evt) {
                    try {
                        const coord = map.screenToGeo(
                            evt.currentPointer.viewportX,
                            evt.currentPointer.viewportY
                        );
                        
                        const lat = coord.lat;
                        const lng = coord.lng;
                        
                        addLogEntry(`Map clicked at: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                        updatePosition(lat, lng);
                        
                        // Update input fields
                        document.getElementById('latitude').value = lat.toFixed(6);
                        document.getElementById('longitude').value = lng.toFixed(6);
                    } catch (e) {
                        showError("Error handling map click: " + e.message);
                    }
                });
                addLogEntry('Map click handler set up');
            }
        }
        
        // Get Speed Limit button
        document.getElementById('get-speed-limit').addEventListener('click', function() {
            try {
                const latInput = document.getElementById('latitude').value;
                const lngInput = document.getElementById('longitude').value;
                
                if (!latInput || !lngInput) {
                    showError("Please enter both latitude and longitude");
                    return;
                }
                
                const lat = parseFloat(latInput);
                const lng = parseFloat(lngInput);
                
                if (isNaN(lat) || isNaN(lng)) {
                    showError("Invalid coordinates. Please enter valid numbers.");
                    return;
                }
                
                if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    showError("Coordinates out of range. Latitude must be between -90 and 90, longitude between -180 and 180.");
                    return;
                }
                
                addLogEntry(`Getting speed limit for manual coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                updatePosition(lat, lng);
            } catch (e) {
                showError("Error getting speed limit: " + e.message);
            }
        });
        
        // Locate Me button
        document.getElementById('locate-me').addEventListener('click', function() {
            try {
                addLogEntry('Locating user...');
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            addLogEntry(`Located at: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                            updatePosition(lat, lng);
                            
                            // Update input fields
                            document.getElementById('latitude').value = lat.toFixed(6);
                            document.getElementById('longitude').value = lng.toFixed(6);
                            
                            // Store timestamp for speed calculation
                            lastLocation = {lat, lng};
                            lastTimestamp = position.timestamp;
                            
                            // Show current speed if available
                            if (position.coords.speed !== null && position.coords.speed !== undefined) {
                                updateCurrentSpeed(position.coords.speed, position.coords.heading);
                            }
                        },
                        function(error) {
                            showError("Geolocation error: " + error.message);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                } else {
                    showError("Geolocation is not supported by your browser");
                }
            } catch (e) {
                showError("Error locating user: " + e.message);
            }
        });
        
        // Start/Stop Tracking button
        document.getElementById('start-tracking').addEventListener('click', function() {
            try {
                if (isTracking) {
                    // Stop tracking
                    if (watchId !== null) {
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                    }
                    isTracking = false;
                    document.getElementById('start-tracking').textContent = 'Start Tracking';
                    document.getElementById('current-speed-container').style.display = 'none';
                    addLogEntry('Tracking stopped');
                } else {
                    // Clear previous positions
                    previousPositions = [];
                    if (routeLine) {
                        map.removeObject(routeLine);
                        routeLine = null;
                    }
                    
                    // Start tracking
                    if (navigator.geolocation) {
                        addLogEntry('Starting location tracking...');
                        watchId = navigator.geolocation.watchPosition(
                            function(position) {
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                                
                                // Only log position changes that are significant
                                const lastPos = previousPositions.length > 0 ? previousPositions[previousPositions.length - 1] : null;
                                if (!lastPos || calculateDistance(lastPos.lat, lastPos.lng, lat, lng) > 0.0001) {
                                    addLogEntry(`Tracking update: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                                    
                                    // Add to previous positions
                                    previousPositions.push({lat, lng, timestamp: position.timestamp});
                                    
                                    // Keep only the last 100 positions to avoid memory issues
                                    if (previousPositions.length > 100) {
                                        previousPositions.shift();
                                    }
                                    
                                    // Update the route line on the map
                                    updateRouteLine();
                                    
                                    // Calculate and update current speed
                                    if (lastLocation && lastTimestamp) {
                                        const distance = calculateDistance(
                                            lastLocation.lat, lastLocation.lng, 
                                            lat, lng
                                        );
                                        const timeInHours = (position.timestamp - lastTimestamp) / 3600000; // ms to hours
                                        
                                        if (timeInHours > 0) {
                                            const speed = position.coords.speed !== null && position.coords.speed !== undefined 
                                                ? position.coords.speed * 3.6 // m/s to km/h
                                                : (distance / timeInHours);
                                            
                                            updateCurrentSpeed(speed, position.coords.heading);
                                        }
                                    }
                                    
                                    // Update last location and timestamp
                                    lastLocation = {lat, lng};
                                    lastTimestamp = position.timestamp;
                                    
                                    // Update position on map
                                    updatePosition(lat, lng);
                                    
                                    // Update input fields
                                    document.getElementById('latitude').value = lat.toFixed(6);
                                    document.getElementById('longitude').value = lng.toFixed(6);
                                }
                            },
                            function(error) {
                                showError("Tracking error: " + error.message);
                                // Turn off tracking on error
                                if (watchId !== null) {
                                    navigator.geolocation.clearWatch(watchId);
                                    watchId = null;
                                }
                                isTracking = false;
                                document.getElementById('start-tracking').textContent = 'Start Tracking';
                                document.getElementById('current-speed-container').style.display = 'none';
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 5000,
                                maximumAge: 0
                            }
                        );
                        isTracking = true;
                        document.getElementById('start-tracking').textContent = 'Stop Tracking';
                        document.getElementById('current-speed-container').style.display = 'block';
                    } else {
                        showError("Geolocation is not supported by your browser");
                    }
                }
            } catch (e) {
                showError("Tracking error: " + e.message);
            }
        });
        
        // Function to update the route line on map
        function updateRouteLine() {
            if (map && previousPositions.length > 1) {
                // Remove old line
                if (routeLine) {
                    map.removeObject(routeLine);
                }
                
                // Create line string geometry
                const lineString = new H.geo.LineString();
                
                // Add points to line string
                previousPositions.forEach(pos => {
                    lineString.pushPoint({lat: pos.lat, lng: pos.lng});
                });
                
                // Create line
                routeLine = new H.map.Polyline(
                    lineString,
                    { 
                        style: { 
                            lineWidth: 4,
                            strokeColor: '#4285f4',
                            lineCap: 'round'
                        }
                    }
                );
                
                // Add line to map
                map.addObject(routeLine);
            }
        }
        
        // Function to calculate distance between two points in km (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1); 
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            const distance = R * c; // Distance in km
            return distance;
        }
        
        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }
        
        // Function to update current speed display
        function updateCurrentSpeed(speed, heading) {
            const speedKmh = speed >= 0 ? (speed * 3.6).toFixed(1) : 0; // Convert m/s to km/h
            document.getElementById('current-speed').textContent = speedKmh;
            
            // Show speed container
            document.getElementById('current-speed-container').style.display = 'block';
            
            // Update direction if available
            if (heading !== null && heading !== undefined) {
                const direction = getCardinalDirection(heading);
                document.getElementById('current-direction').textContent = direction;
            } else {
                document.getElementById('current-direction').textContent = 'N/A';
            }
        }
        
        // Function to convert heading in degrees to cardinal direction
        function getCardinalDirection(heading) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(heading / 45) % 8;
            return directions[index];
        }
        
        // Traffic buttons
        document.getElementById('show-traffic').addEventListener('click', function() {
            try {
                addLogEntry('Showing traffic layer');
                if (!trafficLayer && platform) {
                    trafficLayer = platform.createDefaultLayers().vector.normal.traffic;
                    map.addLayer(trafficLayer);
                }
            } catch (e) {
                showError("Error showing traffic: " + e.message);
            }
        });
        
        document.getElementById('hide-traffic').addEventListener('click', function() {
            try {
                addLogEntry('Hiding traffic layer');
                if (trafficLayer) {
                    map.removeLayer(trafficLayer);
                    trafficLayer = null;
                }
            } catch (e) {
                showError("Error hiding traffic: " + e.message);
            }
        });
        
        // Toggle logs button
        document.getElementById('toggle-logs').addEventListener('click', function() {
            const logPanel = document.getElementById('log-panel');
            if (logPanel.style.display === 'none' || !logPanel.style.display) {
                logPanel.style.display = 'block';
                document.getElementById('toggle-logs').textContent = 'Hide Logs';
            } else {
                logPanel.style.display = 'none';
                document.getElementById('toggle-logs').textContent = 'Show Logs';
            }
        });
        
        // Try alternate API button
        document.getElementById('try-alternate').addEventListener('click', function() {
            if (currentLat !== null && currentLng !== null) {
                getSpeedLimitAlternate(currentLat, currentLng);
            }
        });
        
        // Function to update position on map
        function updatePosition(lat, lng) {
            try {
                // Store current coordinates
                currentLat = lat;
                currentLng = lng;
                
                // Update marker
                if (positionMarker && map) {
                    map.removeObject(positionMarker);
                }
                
                if (map) {
                    positionMarker = new H.map.Marker({ lat, lng });
                    map.addObject(positionMarker);
                    
                    // Center map on position
                    map.setCenter({ lat, lng });
                }
                
                // Update location info
                document.getElementById('location-info').textContent = 
                    `Latitude: ${lat.toFixed(6)}, Longitude: ${lng.toFixed(6)}`;
                
                // Show the speed info panel
                document.getElementById('speed-info').style.display = 'block';
                
                // Get speed limit
                getSpeedLimit(lat, lng);
            } catch (e) {
                showError("Error updating position: " + e.message);
            }
        }
        
        // Function to get speed limit from server
        function getSpeedLimit(lat, lng) {
            try {
                // Show loading state
                document.getElementById('speed-circle').textContent = '...';
                document.getElementById('speed-limit-text').textContent = 'Loading...';
                document.getElementById('road-name').textContent = 'Please wait';
                document.getElementById('speed-note').textContent = '';
                document.getElementById('try-alternate').style.display = 'none';
                
                addLogEntry(`Requesting speed limit for ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                
                // Make API request
                fetch(`/speed-limit/api/data?lat=${lat}&lng=${lng}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server error: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.speedLimit) {
                            document.getElementById('speed-circle').textContent = data.speedLimit;
                            document.getElementById('speed-limit-text').textContent = 
                                `Speed Limit (${data.unit})`;
                            
                            // Display note if available
                            if (data.note) {
                                document.getElementById('speed-note').textContent = data.note;
                            } else {
                                document.getElementById('speed-note').textContent = '';
                            }
                            
                            if (data.road) {
                                document.getElementById('road-name').textContent = data.road;
                                addLogEntry(`Found speed limit: ${data.speedLimit} ${data.unit} on ${data.road}`);
                            } else {
                                document.getElementById('road-name').textContent = 'Unknown Road';
                                addLogEntry(`Found speed limit: ${data.speedLimit} ${data.unit} on unknown road`);
                            }
                            // Hide alternate option
                            document.getElementById('try-alternate').style.display = 'none';
                        } else {
                            document.getElementById('speed-circle').textContent = '--';
                            document.getElementById('speed-limit-text').textContent = 'No Speed Limit Data';
                            document.getElementById('road-name').textContent = 'Unknown Road';
                            document.getElementById('speed-note').textContent = '';
                            addLogEntry('No speed limit data available for this location');
                            // Show alternate option
                            document.getElementById('try-alternate').style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching speed limit:', error);
                        document.getElementById('speed-circle').textContent = '--';
                        document.getElementById('speed-limit-text').textContent = 'Error';
                        document.getElementById('road-name').textContent = 'Could not get speed limit';
                        document.getElementById('speed-note').textContent = '';
                        showError("Error fetching speed limit: " + error.message);
                        // Show alternate option
                        document.getElementById('try-alternate').style.display = 'block';
                    });
            } catch (e) {
                showError("Error getting speed limit: " + e.message);
            }
        }
        
        // Function to get speed limit using alternate API
		function getSpeedLimitAlternate(lat, lng) {
		    try {
		        // Show loading state
		        document.getElementById('speed-circle').textContent = '...';
		        document.getElementById('speed-limit-text').textContent = 'Loading (Alt)...';
		        document.getElementById('road-name').textContent = 'Please wait';
		        document.getElementById('speed-note').textContent = '';
		        
		        addLogEntry(`Requesting speed limit (alternate method) for ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
		        
		        // Make API request to alternate endpoint
		        fetch(`/speed-limit/api/data/alternate?lat=${lat}&lng=${lng}`)
		            .then(response => {
		                if (!response.ok) {
		                    throw new Error(`Server error: ${response.status}`);
		                }
		                return response.json();
		            })
		            .then(data => {
		                if (data.speedLimit) {
		                    document.getElementById('speed-circle').textContent = data.speedLimit;
		                    document.getElementById('speed-limit-text').textContent = 
		                        `Speed Limit (${data.unit})`;
		                    
		                    // Display note if available
		                    if (data.note) {
		                        document.getElementById('speed-note').textContent = data.note;
		                    } else {
		                        document.getElementById('speed-note').textContent = '';
		                    }
		                    
		                    if (data.road) {
		                        document.getElementById('road-name').textContent = data.road;
		                        addLogEntry(`Found speed limit (alt): ${data.speedLimit} ${data.unit} on ${data.road}`);
		                    } else {
		                        document.getElementById('road-name').textContent = 'Unknown Road';
		                        addLogEntry(`Found speed limit (alt): ${data.speedLimit} ${data.unit} on unknown road`);
		                    }
		                } else {
		                    document.getElementById('speed-circle').textContent = '--';
		                    document.getElementById('speed-limit-text').textContent = 'No Speed Limit Data';
		                    document.getElementById('road-name').textContent = 'Unknown Road';
		                    document.getElementById('speed-note').textContent = '';
		                    addLogEntry('No speed limit data available (alternate method)');
		                }
		            })
		            .catch(error => {
		                console.error('Error fetching speed limit (alt):', error);
		                document.getElementById('speed-circle').textContent = '--';
		                document.getElementById('speed-limit-text').textContent = 'Error';
		                document.getElementById('road-name').textContent = 'Could not get speed limit';
		                document.getElementById('speed-note').textContent = '';
		                showError("Error fetching speed limit (alt): " + error.message);
		            });
		    } catch (e) {
		        showError("Error getting speed limit (alt): " + e.message);
		    }
		}
									        
									        // Set default values for latitude and longitude
									        document.getElementById('latitude').value = "12.9716";
									        document.getElementById('longitude').value = "77.5946";
									        
									        // Check if maps API is available
									        function checkMapsApiAvailability() {
									            if (typeof H !== 'undefined' && H.service && H.service.Platform) {
									                return true;
									            }
									            return false;
									        }
									        
									        // Function to handle map loading issues
									        function handleMapLoad() {
									            // Show loading overlay
									            document.getElementById('loading-overlay').style.display = 'flex';
									            
									            // Check if maps API is loaded
									            if (checkMapsApiAvailability()) {
									                // Try to initialize map
									                setTimeout(() => {
									                    initMapWithRetry();
									                }, 500);
									            } else {
									                // API not loaded, try to reload scripts
									                addLogEntry('HERE Maps API not loaded, attempting to reload scripts...', 'error');
									                
									                // Function to load script dynamically
									                function loadScript(src, callback) {
									                    let script = document.createElement('script');
									                    script.src = src;
									                    script.async = true;
									                    script.defer = true;
									                    script.onload = callback;
									                    script.onerror = () => {
									                        addLogEntry(`Failed to load script: ${src}`, 'error');
									                    };
									                    document.head.appendChild(script);
									                }
									                
									                // Load scripts sequentially
									                loadScript('https://js.api.here.com/v3/3.1/mapsjs-core.js', () => {
									                    loadScript('https://js.api.here.com/v3/3.1/mapsjs-service.js', () => {
									                        loadScript('https://js.api.here.com/v3/3.1/mapsjs-ui.js', () => {
									                            loadScript('https://js.api.here.com/v3/3.1/mapsjs-mapevents.js', () => {
									                                // All scripts loaded, try to initialize map
									                                setTimeout(() => {
									                                    initMapWithRetry();
									                                }, 500);
									                            });
									                        });
									                    });
									                });
									            }
									        }
									        
									        // Initialize the map when page loads
									        window.onload = function() {
									            handleMapLoad();
									        };
									        
									        // Handle errors that might occur after initial loading
									        window.onerror = function(message, source, lineno, colno, error) {
									            if (message.includes('H is not defined') || message.includes('H.service')) {
									                addLogEntry('Caught map loading error, attempting recovery...', 'error');
									                handleMapLoad();
									                return true; // Prevents the default error handling
									            }
									            return false; // Let default error handling continue for other errors
									        };
									    </script>
									</body>
									</html>