<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Thinture GPS</title>
    <link rel="icon" type="image/x-icon" href="/THINTURE_IMAGE/favicon.jpg">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" type="text/css" th:href="@{/css/style.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/adddevicesstyle.css}">

    <style>
        /* Light text color for dark background */
        body {
            color: #f8f9fa; /* Light text color for readability */
            background-color: #343a40; /* Dark background */
        }

        h2, h3, p {
            color: #f1f1f1; /* Light text for headings and paragraphs */
        }

        label {
            color: #adb5bd; /* Lighter shade for labels */
        }

        .tab-link {
            color: #f1f1f1; /* Light text for tab links */
        }

        .tab-link.active {
            color: #ffffff; /* White text for the active tab */
        }

        #selectedClientId {
            color: #adb5bd; /* Lighter text for selected client info */
        }

        button {
            color: #ffffff; /* White text for buttons */
            background-color: #007bff; /* Blue background for buttons */
            border: none;
        }

        button:hover {
            background-color: #0056b3; /* Darker blue on hover */
        }

        input {
            color: #f8f9fa; /* Light text for input fields */
            background-color: #495057; /* Dark input background */
        }

        input::placeholder {
            color: #ced4da; /* Light gray placeholder text */
        }
    </style>
</head>

<body>
    <header th:replace="~{navigation :: navbar}"></header>

    <div class="card">
        <h2>DEVICE TO CLIENT</h2>

        <!-- Client Dropdown -->
        <label for="ClientName">Select Client:</label>
        <select id="ClientDropdown" onchange="fetchSelectedClientId()">
            <option value="" disabled selected>Select Client</option>
        </select>

        <!-- Display Selected Client ID -->
        <p id="selectedClientId">Selected Client ID: </p>

        <!-- Tab Navigation -->
        <div class="tab-container">
            <button class="tab-link active" onclick="openTab('single')">Single</button>
            <button class="tab-link" onclick="openTab('dual')">Dual</button>
        </div>

        <!-- Single Serial Form -->
        <div id="single" class="tab-content active">
            <h3>Single Serial Number</h3>
            <input type="text" id="singleSerial" placeholder="Enter Serial Number">
            <input type="text" id="singleImei" placeholder="Enter IMEI Number">
            <button onclick="addSingleSerial()">Add Serial</button>
        </div>

        <!-- Dual Serial Form -->
        <div id="dual" class="tab-content">
            <h3>Dual Serial Number Range</h3>
            <input type="text" id="startSerial" placeholder="Start Serial Number">
            <input type="text" id="endSerial" placeholder="End Serial Number">
            <input type="text" id="removedSerial" placeholder="Remove Serial Number (Optional)">
            <button onclick="addDualSerial()">Add Range</button>
        </div>

        <!-- Serial Table -->
        <div id="serialTableContainer"></div>

        <!-- Add Devices Button -->
        <button id="addDevicesButton" style="display: none;" onclick="addDevices()">Add Devices</button>
    </div>

    <script>
        const PREFIX = "TH/M4G/";

        // ‚úÖ Open Tabs
        function openTab(tabName) {
            document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
            document.querySelectorAll(".tab-link").forEach(tab => tab.classList.remove("active"));
            document.getElementById(tabName).classList.add("active");
            document.querySelector([onclick="openTab('${tabName}')"]).classList.add("active");
        }

        // ‚úÖ Fetch and Populate Client Dropdown
        document.addEventListener("DOMContentLoaded", function () {
            fetchClients();
        });

        function fetchClients() {
            console.log("Fetching client data...");
            fetch("/client/all")
                .then(response => response.json())
                .then(clients => {
                    const dropdown = document.getElementById("ClientDropdown");
                    dropdown.innerHTML = `<option value="" disabled selected>Select Client</option>`;
                    clients.forEach(client => {
                        let option = document.createElement("option");
                        option.value = client.id; // ‚úÖ Store Client ID
                        option.textContent = client.name; // ‚úÖ Display Client Name
                        dropdown.appendChild(option);
                    });
                    console.log("‚úÖ Client dropdown populated successfully.");
                })
                .catch(error => console.error("‚ùå Error fetching clients:", error));
        }

        // ‚úÖ Fetch Selected Client ID
        function fetchSelectedClientId() {
            const dropdown = document.getElementById("ClientDropdown");
            const clientId = dropdown.value;
            const clientName = dropdown.options[dropdown.selectedIndex]?.text;
            document.getElementById("selectedClientId").innerText = `Selected Client: ${clientName} (ID: ${clientId})`;
            console.log(`üìå Client Selected: ${clientName} (ID: ${clientId})`);
        }

        // ‚úÖ Add Single Serial Number
        function addSingleSerial() {
            console.log("üîπ Attempting to add single serial...");

            const serial = document.getElementById("singleSerial").value.trim();
            const imei = document.getElementById("singleImei").value.trim();
            const clientDropdown = document.getElementById("ClientDropdown");
            const clientId = clientDropdown.value;

            if (!serial || !imei || !clientId) {
                Swal.fire({ icon: 'error', title: '‚ùå Missing Input', text: 'Please enter Serial, IMEI, and select a Client.' });
                return;
            }

            const payload = { serialNo: `${PREFIX}${serial}`, imei, clientId };

            console.log("üì§ Sending Single Serial Payload:", payload);

            fetch('/client/add-single', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            })
            .then(response => response.json())
            .then(data => {
                console.log("‚úÖ API Response:", data);
                if (data.success === "true") {
                    Swal.fire({ icon: 'success', title: '‚úÖ Success', text: 'Single Serial added successfully!' });
                    document.getElementById("singleSerial").value = "";
                    document.getElementById("singleImei").value = "";
                } else {
                    Swal.fire({ icon: 'error', title: '‚ùå Error', text: 'Failed to add Single Serial. Please try again.' });
                }
            })
            .catch(error => {
                console.error('‚ùå API Error:', error);
                Swal.fire({ icon: 'error', title: '‚ùå Error', text: 'Failed to add Single Serial. Please check your network and try again.' });
            });
        }

        // ‚úÖ Add Dual Serial Number Range
		// ‚úÖ Updated Dual Serial Input with multiple removal support
		function addDualSerial() {
		    console.log("üîπ Attempting to add dual serials...");

		    const startSerial = parseInt(document.getElementById("startSerial").value.trim());
		    const endSerial = parseInt(document.getElementById("endSerial").value.trim());
		    const removedSerialInput = document.getElementById("removedSerial").value.trim();
		    const clientDropdown = document.getElementById("ClientDropdown");
		    const clientId = clientDropdown.value;

		    if (isNaN(startSerial) || isNaN(endSerial) || startSerial > endSerial || !clientId) {
		        Swal.fire({ icon: 'error', title: '‚ùå Invalid Input', text: 'Ensure valid Start/End Serial and select a Client.' });
		        return;
		    }

		    // Parse removed serials into a Set for fast lookup
		    const removedSet = new Set();
		    if (removedSerialInput) {
		        removedSerialInput.split(",").forEach(num => {
		            const parsed = parseInt(num.trim());
		            if (!isNaN(parsed)) removedSet.add(parsed);
		        });
		    }

		    const uniqueSerials = new Set();
		    for (let i = startSerial; i <= endSerial; i++) {
		        if (removedSet.has(i)) {
		            console.log(`‚ö†Ô∏è Skipping removed serial: ${i}`);
		            continue;
		        }
		        uniqueSerials.add(PREFIX + i);
		    }

		    const serialNumbers = Array.from(uniqueSerials);

		    const payload = {
		        serialNumbers: serialNumbers,
		        clientId: clientId
		    };

		    console.log("üì§ Sending Dual Serial Payload:", payload);

		    fetch('/client/add-dual', {
		        method: 'POST',
		        headers: { 'Content-Type': 'application/json' },
		        body: JSON.stringify(payload),
		    })
		    .then(response => response.json())
		    .then(data => {
		        console.log("‚úÖ API Response:", data);
		        if (data.success === "true") {
		            Swal.fire({ icon: 'success', title: '‚úÖ Success', text: 'Dual Serial Range added successfully!' });
		            document.getElementById("startSerial").value = "";
		            document.getElementById("endSerial").value = "";
		            document.getElementById("removedSerial").value = "";
		        } else {
		            Swal.fire({ icon: 'error', title: '‚ùå Error', text: 'Failed to add Dual Serial Range. Please try again.' });
		        }
		    })
		    .catch(error => {
		        console.error('‚ùå API Error:', error);
		        Swal.fire({ icon: 'error', title: '‚ùå Error', text: 'Failed to add Dual Serial Range. Please check your network and try again.' });
		    });
		}


        openTab("single");
    </script>
</body>
</html>
