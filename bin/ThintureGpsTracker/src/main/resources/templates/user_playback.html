
<!DOCTYPE html>
<html lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Thinture GPS</title>
		    <link rel="icon" type="image/x-icon" href="THINTURE_IMAGE/favicon.jpg">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/sdist/MarkerCluster.Default.css">
	<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
	
	<link rel="stylesheet" type="text/css" th:href="@{/css/style.css}">
    <style>
		body {
								    font-family: Arial, sans-serif;
								    margin: 0;
								    padding: 0;
								    position: relative;
								}

								body::before {
								    content: "";
								    position: fixed;
								    top: 0;
								    left: 0;
								    width: 100%;
								    height: 100%;
								    background: url('THINTURE_IMAGE/mainbg.jpg') no-repeat center center/cover;
								    filter: blur(10px);
								    z-index: -1; /* Ensures the background remains behind the content */
								}
								@media only screen and (max-width: 768px) {
										    body {
										        background-attachment: fixed; /* Fixes background on small screens */
										        min-height: 100vh; /* Ensures full height */
										        font-size: 14px; /* Adjust font size for better readability */
												background-size: cover;
										    }
										}

		#map {
				position: absolute;
				height: calc(100vh - 150px);
				position: sticky;
				top:85px;
			}

		/* Icon and Animation Styles */
		.custom-icon img {
		    transform-origin: center center;
		    transition: transform 0.5s ease-in-out;
		}

		@keyframes blink-zoom {
		    0% { transform: scale(1) rotate(var(--rotation)); }
		    50% { transform: scale(1.3) rotate(var(--rotation)); }
		    100% { transform: scale(1) rotate(var(--rotation)); }
		}

		/* Base */
		.alert-container {
		   display: flex;
		   flex-direction: column;
		   gap: 10px;
		   max-width: 400px;
		   position: fixed;
		   top: 20px;
		   right: 20px;
		   z-index: 1000;
		}

		/* Alert Styles */
		.live-alert, .parking-alert {
		   opacity: 0;
		   transform: translateX(100%);
		   animation: slideIn 0.5s ease-out forwards;
		   display: flex;
		   align-items: center;
		   gap: 15px;
		   padding: 15px 20px;
		   border-radius: 10px;
		   box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
		   backdrop-filter: blur(5px);
		   border: 1px solid rgba(255, 255, 255, 0.1);
		   color: white;
		   width: 100%;
		   box-sizing: border-box;
		}

		.live-alert { background: linear-gradient(135deg, #27ae60, #2ecc71); }
		.parking-alert { background: linear-gradient(135deg, #2c3e50, #3498db); }

		/* Icons */
		.live-icon, .parking-icon {
		   width: 32px;
		   height: 32px;
		   animation: pulse 2s infinite;
		   filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
		   flex-shrink: 0;
		}

		/* Info */
		.live-info, .parking-info {
		   display: flex;
		   flex-direction: column;
		   gap: 4px;
		   flex: 1;
		}

		.live-info strong, .parking-info strong {
		   font-size: 16px;
		   margin-bottom: 2px;
		}

		.live-info span, .parking-info span {
		   font-size: 14px;
		   opacity: 0.9;
		}

		/* Close Button */
		.alert-close {
		   position: absolute;
		   top: 8px;
		   right: 8px;
		   background: none;
		   border: none;
		   color: white;
		   font-size: 20px;
		   cursor: pointer;
		   opacity: 0.7;
		   transition: all 0.3s ease;
		   padding: 0;
		   width: 24px;
		   height: 24px;
		   display: flex;
		   align-items: center;
		   justify-content: center;
		   border-radius: 50%;
		}

		.alert-close:hover {
		   opacity: 1;
		   background: rgba(255, 255, 255, 0.1);
		   transform: scale(1.1);
		}

		/* Animations */
		@keyframes slideIn {
		   0% { transform: translateX(100%); opacity: 0; }
		   100% { transform: translateX(0); opacity: 1; }
		}

		@keyframes slideOut {
		   0% { transform: translateX(0); opacity: 1; }
		   100% { transform: translateX(100%); opacity: 0; }
		}

		@keyframes pulse {
		   0%, 100% { transform: scale(1); }
		   50% { transform: scale(1.1); }
		}

		.slide-out { animation: slideOut 0.5s ease-out forwards; }

		/* Responsive */
		@media (max-width: 768px) {
		   .alert-container {
		       max-width: 100%;
		       padding: 0 10px;
		   }
		   
		   .live-alert, .parking-alert { padding: 12px 15px; }
		   .live-info strong, .parking-info strong { font-size: 14px; }
		   .live-info span, .parking-info span { font-size: 12px; }
		}

		.status-indicator {
		    padding: 2px 6px;
		    border-radius: 3px;
		    color: white;
		    font-weight: normal;
		}

		/* Status Colors */
		.status-parked {
		    background-color: #f39c12;
		}

		.status-running {
		    background-color: #27ae60;
		}

		.ignition-on {
		    color: #27ae60;
		    font-weight: bold;
		}

		.ignition-off {
		    color: #e74c3c;
		    font-weight: bold;
		}

		/* Update Status Styles */
		.live-update {
		    border-bottom: 2px solid #27ae60;
		}

		.last-known {
		    border-bottom: 2px solid #e74c3c;
		}

		/* Responsive Styles */
		@media (max-width: 768px) {
		    .alert-container {
		        max-width: 100%;
		        padding: 0 10px;
		    }

		    .parking-alert {
		        padding: 12px 15px;
		    }

		    .parking-info strong {
		        font-size: 14px;
		    }

		    .parking-info span {
		        font-size: 12px;
		    }
		}
		
		
		/* Sidebar Styles */
		#sidebar {
		    position: fixed;
		    right: -400px;
		    top: 0;
		    width: 380px;
		    height: 100vh;
		    background: rgba(255, 255, 255, 0.95);
		    box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
		    transition: right 0.3s ease;
		    z-index: 1000;
		    padding: 20px;
		    backdrop-filter: blur(10px);
		    border-left: 1px solid rgba(0, 0, 0, 0.1);
		}

		#sidebar.active {
		    right: 0;
		}

		/* Essential toggle button and sidebar styles */
		#toggleButton {
		    position: fixed;
		    top: 150px;
		    right: 20px;
		    z-index: 1001;
		    background: darkblue;
		    color: white;
		    border: none;
		    border-radius: 8px;
		    padding: 12px 15px;
		    font-size: 10px;
		    cursor: pointer;
		    transition: all 0.3s ease;
		    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
		}

		#toggleButton:hover {
		    background: blue;
		    transform: scale(1.05);
		}

		#toggleButton.active {
		    right: 400px; /* Matches sidebar width */
		}

		/* Sidebar positioning and transitions */
		#sidebar {
		    position: fixed;
		    right: -450px; /* Hidden by default */
		    top: 150px;
		    width: 380px;
		    height: 100vh;
		    background: rgba(0, 0, 0, 0.4);
		    box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
		    transition: right 0.3s ease;
		    z-index: 1000;
		    padding: 5px;
		    backdrop-filter: blur(10px);
		    border-left: 1px solid rgba(0, 0, 0, 0.1);
		}

		#sidebar.active {
		    right: 0;
		}

		/* Sidebar header styles */
		#sidebar h2 {
		    color:darkblue;
		    font-size: 20px;
		    margin-bottom: 20px;
		    padding-bottom: 10px;
		    border-bottom: 2px solid #3498db;
		}

		/* Search bar styles */
		#searchBar {
		    width: calc(50% - 14px);
		    padding: 8px;
		    border: 1px solid #e0e0e0;
		    border-radius: 8px;
		    margin-bottom: 20px;
		    font-size: 10px;
		    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
		}

		#searchBar:focus {
		    outline: none;
		    border-color: #3498db;
		    box-shadow: 0 2px 10px rgba(52, 152, 219, 0.2);
		}

		/* Mobile responsiveness */
		@media (max-width: 768px) {
		    #sidebar {
		        width: 100%;
		        right: -100%;
		    }
		    
		    #toggleButton.active {
		        right: 20px;
		    }
		}

		/* Table styles */
		#sidebar table {
		    width: 100%;
		    border-collapse: collapse;
		    margin-top: 10px;
		    background: white;
		    border-radius: 8px;
		    overflow: hidden;
		    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
		}

		#sidebar th {
		    background:darkblue;
		    color: white;
		    padding: 2px;
		    font-size: 10px;
		    text-align: left;
		    font-weight: 600;
		}

		#sidebar td {
		    padding: 3px;
		    font-size: 13px;
		    border-bottom: 1px solid #eee;
		}
		#map {
			position: absolute;
							height: calc(120vh - 150px);
							position: sticky;
							top:85px;
						}
				.notification {
					display: none;
				    position: fixed;
				    bottom: 20px;
				    right: 20px;
				    background: #fff;
				    border: 1px solid #ddd;
				    border-radius: 5px;
				    padding: 10px 20px;
				    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
				    display: flex;
				    align-items: center;
				    z-index: 1000;
				    opacity: 0;
				    transform: translateY(10px);
				    transition: opacity 0.5s ease, transform 0.5s ease;
				}

				.notification.animate {
				    opacity: 1;
				    transform: translateY(0);
				    animation: pulse 1s ease-in-out;
				}

				@keyframes pulse {
				    0% {
				        transform: scale(1);
				    }
				    50% {
				        transform: scale(1.05);
				    }
				    100% {
				        transform: scale(1);
				    }
				}

				.notification-icon {
				    font-size: 24px;
				    margin-right: 10px;
				}

				.notification-content h4 {
				    margin: 0;
				    font-size: 16px;
				    color: #333;
				}

				.notification-content p {
				    margin: 0;
				    font-size: 14px;
				    color: #666;
				}

				.notification-content small {
				    display: block;
				    margin-top: 5px;
				    font-size: 12px;
				    color: #999;
				}

				.marker-cluster-small {
				    background-color: rgba(181, 226, 140, 0.6);
				    border: 2px solid rgba(110, 204, 57, 0.8);
				    color: white;
				    border-radius: 20px;
				    width: 40px;
				    height: 40px;
				    line-height: 40px;
				    text-align: center;
				}

				.marker-cluster-medium {
				    background-color: rgba(241, 211, 87, 0.6);
				    border: 2px solid rgba(240, 194, 12, 0.8);
				    color: white;
				    border-radius: 30px;
				    width: 50px;
				    height: 50px;
				    line-height: 50px;
				    text-align: center;
				}

				.marker-cluster-large {
				    background-color: rgba(253, 156, 115, 0.6);
				    border: 2px solid rgba(241, 128, 23, 0.8);
				    color: white;
				    border-radius: 40px;
				    width: 60px;
				    height: 60px;
				    line-height: 60px;
				    text-align: center;
				}
				.replay-button {
				    display: none; /* Hide button initially */
				}

/* Small Cluster */
.marker-cluster-small {
    background-color: rgba(181, 226, 140, 0.6);
    border: 2px solid rgba(110, 204, 57, 0.8);
    border-radius: 20px;
    width: 40px;
    height: 40px;
    line-height: 40px;
    text-align: center;
    font-size: 14px;
    color: white;
    font-weight: bold;
}

/* Medium Cluster */
.marker-cluster-medium {
    background-color: rgba(241, 211, 87, 0.6);
    border: 2px solid rgba(240, 194, 12, 0.8);
    border-radius: 30px;
    width: 50px;
    height: 50px;
    line-height: 50px;
    text-align: center;
    font-size: 16px;
    color: white;
    font-weight: bold;
}

/* Large Cluster */
.marker-cluster-large {
    background-color: rgba(253, 156, 115, 0.6);
    border: 2px solid rgba(241, 128, 23, 0.8);
    border-radius: 40px;
    width: 60px;
    height: 60px;
    line-height: 60px;
    text-align: center;
    font-size: 18px;
    color: white;
    font-weight: bold;
}

/* Cluster Count Number */
.marker-cluster div {
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: Arial, sans-serif;
}

/* Hover Effect */
.marker-cluster:hover {
    transform: scale(1.1);
    transition: transform 0.2s ease-in-out;
}
.highlight-marker {
           animation: bounce 0.5s ease-in-out 2;
       }

       @keyframes bounce {
           0%, 100% { transform: translateY(0); }
           50% { transform: translateY(-10px); }
       }
	   .popup-container {
	       background: white;
	       border-radius: 10px;
	       box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.3);
	       padding: 20px;
	       width: 400px;
	       max-width: 90%; /* Responsive on smaller screens */
	       position: fixed;
	       top: 50%;
	       left: 50%;
	       transform: translate(-50%, -50%);
	       z-index: 1000;
	       display: none;
	       animation: fadeIn 0.3s ease-in-out;
	   }

	   /* Add a background overlay */
	   .popup-overlay {
	       position: fixed;
	       top: 0;
	       left: 0;
	       width: 100%;
	       height: 100%;
	       background: rgba(0, 0, 0, 0.5);
	       z-index: 999;
	       display: none;
	   }

	   /* Close Button */
	   .close-btn {
	       position: absolute;
	       top: 10px;
	       right: 15px;
	       background: red;
	       color: white;
	       border: none;
	       border-radius: 50%;
	       width: 30px;
	       height: 30px;
	       text-align: center;
	       font-size: 20px;
	       cursor: pointer;
	       transition: 0.3s;
	   }

	   .close-btn:hover {
	       background: darkred;
	   }

	   /* Table Styling */
	   .details-table {
	       width: 100%;
	       border-collapse: collapse;
	       background: white;
	       border-radius: 5px;
	       overflow: hidden;
	   }

	   .details-table th {
	       background: #3498db;
	       color: white;
	       padding: 10px;
	       text-align: left;
	   }

	   .details-table td {
	       padding: 8px;
	       border-bottom: 1px solid #ddd;
	   }

	   /* Animation */
	   @keyframes fadeIn {
	       from { opacity: 0; transform: translate(-50%, -55%); }
	       to { opacity: 1; transform: translate(-50%, -50%); }
	   }

	   #vehicleDetailsModal{
		background: rgba(0, 0, 0, 0.5);
	   }
	   /* Modal container */
	   #vehicleDetailsModal {
	     position: relative; /* This makes positioning inside relative to this container */
	     background: white;
		 font-size: 12px;
	     padding: 20px;
	     border-radius: 8px;
	     box-shadow: 0 0 10px rgba(0,0,0,0.3);
	   }

	   /* Close button positioned at top-right */
	   .closeb {
	     position: absolute;
	     top: 10px;    /* Adjust as needed */
	     right: 8px;  /* Adjust as needed */
	     background: none;
	     border: none;
	     font-size: 14px;
	     cursor: pointer;
	     color: red;   /* Or any color you prefer */
	   }

    </style>
</head>
<body>
	<header th:replace="~{navigation_user :: navbar_user}"></header>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
	
	<!-- Toggle Button -->
	<!-- Toggle Button -->
	<button id="toggleButton">☰</button>

	<!-- Sidebar -->
	<!-- Sidebar -->
	<div id="sidebar">
	    <h2>Tracker Details</h2>
	    <input type="text" id="searchBar" placeholder="Search by Device ID">
	    <table>
	        <thead>
	            <tr>
	                <th>Status</th>
	                <th>Device ID</th>
	                <th>Last Upload</th>
	            </tr>
	        </thead>
	        <tbody id="trackerTableBody">
	            <!-- Rows will be dynamically added here -->
	        </tbody>
	    </table>
	</div>

	<!-- ✅ Vehicle Details Modal (Initially Hidden) -->
	<!-- Vehicle Details Modal (initially hidden) -->
	<div id="vehicleDetailsModal" style="display:none; position:fixed; top:30%; left:56%; padding:20px; border-radius:8px; box-shadow:0px 0px 10px gray; z-index:1000;">
	  <h2>Vehicle Details</h2>
	  <table border="1">
	    <tbody id="vehicleDetailsTable">
	      <!-- Data will be dynamically inserted here -->
	    </tbody>
	  </table>
	  <button class="closeb"   onclick="closeVehicleDetails()">X</button>
	</div>

	<!-- Example Details Button inside a popup (dynamically generated in your marker popup) -->
	<button style="padding: 5px 10px; background-color: #2196F3;  border: none; border-radius: 5px; cursor: pointer;"
	        onclick="fetchVehicleDetails(this.getAttribute('data-deviceid'))"
	        data-deviceid="12345">
	  Details
	</button>




	</div>

		
    <script>
		class VehicleTracker {
		    constructor(mapElementId) {
		        this.map = L.map(mapElementId).setView([13.07757, 77.55928], 5);
		        this.markers = {};
		        this.liveDevices = new Set();
		        this.deviceLastUpdate = {};
		        this.previousCourses = {};
		        this.inactivityThreshold = 30000;
		        this.activeAlerts = new Set();
		        this.alertContainer = this.createAlertContainer();

		        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		            attribution: '&copy; OpenStreetMap contributors',
		        }).addTo(this.map);

		        this.loadLastKnownPositions();
		        this.initWebSocket();
		        this.pollOfflineDevices();
		        this.checkInactiveDevices();
		    }

			createAlertContainer() {
			   const container = document.createElement('div');
			   container.className = 'alert-container';
			   document.body.appendChild(container);
			   return container;
			}

			showAlert(vehicle, type) {
			   const deviceId = vehicle.deviceId || vehicle.deviceID || 'Unknown';
			   if (this.activeAlerts.has(deviceId)) return;

			   const config = {
			       parking: {
			           class: 'parking-alert',
			           icon: '/THINTURE_IMAGE/car/parking-area.png',
			           title: 'Vehicle Parked' 
			       },
			       live: {
			           class: 'live-alert', 
			           icon: '/THINTURE_IMAGE/car/car_icon4.png',
			           title: 'Live Message Alert'
			       }
			   };

			   const alertConfig = config[type];
			   const alertDiv = document.createElement('div');
			   alertDiv.className = alertConfig.class;
			   alertDiv.style.opacity = '0';

			   alertDiv.innerHTML = `
			       <img src="${alertConfig.icon}" class="${type}-icon" alt="${type}">
			       <div class="${type}-info">
			           <strong>${alertConfig.title}</strong>
			           <span>Device ID: ${deviceId}</span>
			           <span>Time: ${new Date().toLocaleTimeString()}</span>
			       </div>
			       <button class="alert-close" onclick="this.parentElement.remove(); window.vehicleTracker.removeAlert('${deviceId}')">×</button>
			   `;

			   void alertDiv.offsetWidth;
			   this.alertContainer.appendChild(alertDiv);
			   alertDiv.style.opacity = '1';
			   
			   this.activeAlerts.add(deviceId);

			   setTimeout(() => {
			       if (alertDiv.parentNode) {
			           alertDiv.classList.add('slide-out');
			           setTimeout(() => {
			               alertDiv.remove();
			               this.removeAlert(deviceId);
			           }, 500);
			       }
			   }, 10000);
			}

			showParkingAlert(vehicle) {
			   this.showAlert(vehicle, 'parking');
			}

			showLiveAlert(vehicle) {
			   this.showAlert(vehicle, 'live'); 
			}

			updateVehicleStatusOnMap(vehicle) {
			    const deviceId = vehicle.deviceId || vehicle.deviceID || 'Unknown';
			    const latitude = parseFloat(vehicle.latitude);
			    const longitude = parseFloat(vehicle.longitude);

			    if (!latitude || !longitude) {
			        console.warn(`Invalid coordinates for Device ID: ${deviceId}`);
			        return;
			    }

			    const status = vehicle.vehicleStatus?.trim().toUpperCase();
			    const ignition = vehicle.ignition?.trim().toUpperCase();

			    console.log(`Processing Vehicle: ${deviceId}`);
			    console.log(`Status: ${status}, Ignition: ${ignition}`);

			    if (status === 'RUNNING' || ignition === 'IGON') {
			        console.log(`Displaying Live Alert for ${deviceId}`);
			        this.showLiveAlert(vehicle);
			    } else if (status === 'PARKED') {
			        console.log(`Displaying Parking Alert for ${deviceId}`);
			        this.showParkingAlert(vehicle);
			    } else {
			        console.log(`No alert triggered for ${deviceId}. Status: ${status}, Ignition: ${ignition}`);
			    }

			    const iconPath = status === 'PARKED'
			        ? '/THINTURE_IMAGE/car/parking-area.png'
			        : (status === 'RUNNING' || ignition === 'IGON') 
			            ? '/THINTURE_IMAGE/car/car_icon4.png'
			            : '/THINTURE_IMAGE/car/car_default.png';

			    console.log(`Updating map icon for ${deviceId}: ${iconPath}`);

			    if (this.markers[deviceId]) {
			        // Update existing marker position and icon
			        this.markers[deviceId]
			            .setLatLng([latitude, longitude])
			            .setIcon(this.createIcon(iconPath));
			    } else {
			        // Create a new marker and add it to the cluster group
			        const newMarker = L.marker([latitude, longitude], {
			            icon: this.createIcon(iconPath)
			        }).bindPopup(`
			            <strong>Device ID:</strong> ${deviceId}<br>
			            <strong>Status:</strong> ${status}
			        `);

			        this.markers[deviceId] = newMarker;
			        this.markerClusterGroup.addLayer(newMarker); // Add marker to cluster group
			    }
			

			this.markerClusterGroup = L.markerClusterGroup({
			    iconCreateFunction: function(cluster) {
			        const count = cluster.getChildCount(); // Number of markers in cluster
			        let className = 'marker-cluster-small';

			        if (count > 10) {
			            className = 'marker-cluster-medium';
			        } else if (count > 50) {
			            className = 'marker-cluster-large';
			        }

			        return new L.DivIcon({
			            html: `<div><span>${count}</span></div>`,
			            className,
			            iconSize: [40, 40]
			        });
			    }
			});

			
			}
			
			
			
			
			
		    createOrUpdateMarker(vehicle, isLive = false) {
		        if (!vehicle.latitude || !vehicle.longitude) {
		            console.error('Invalid latitude or longitude for vehicle:', vehicle);
		            return;
		        }

		        const deviceId = vehicle.deviceId || vehicle.deviceID || 'Unknown';
		        const latitude = parseFloat(vehicle.latitude);
		        const longitude = parseFloat(vehicle.longitude);
		        const course = parseFloat(vehicle.course || 0);
		        const ignition = vehicle.ignition || 'IGoff';
		        const vehicleStatus = vehicle.vehicleStatus || vehicle.VehicleStatus || 'Unknown';
		        const speed = vehicle.speed || '0';
				const timeIntervals =vehicle.timeIntervals

		        // Calculate rotation for smooth transition
		        let rotation = course;
		        if (this.previousCourses[deviceId]) {
		            const prevCourse = this.previousCourses[deviceId];
		            const diff = course - prevCourse;
		            if (Math.abs(diff) > 180) {
		                rotation = diff > 0 ? course - 360 : course + 360;
		            }
		        }
		        this.previousCourses[deviceId] = course;

		        if (isLive) {
		            console.log('Live update received:', {
		                deviceId,
		                status: vehicleStatus,
		                ignition,
		                course: rotation,
		                speed,
		                isLive
		            });
		        }

		        const icon = this.getVehicleIcon(rotation, ignition, vehicleStatus);
		        const timestamp = vehicle.timestamp ? new Date(vehicle.timestamp).toLocaleString() : 'N/A';

		        const markerHtml = `
		            <img 
		                src="${icon.path}" 
		                style="transform: rotate(${icon.rotation}deg); width: 38px; height: 38px;" 
		                alt="vehicle-icon"
		                onerror="
		                    console.log('Icon load failed for ${deviceId}:', this.src);
		                    if (!this.retryCount) {
		                        this.retryCount = 1;
		                        this.src = '/THINTURE_IMAGE/car/${icon.color}/car0.png';
		                        console.log('Retrying with path:', this.src);
		                    } else {
		                        console.error('All icon load attempts failed for ${deviceId}');
		                        this.style.display = 'none';
		                    }
		                "
		            >`;

					const popupContent = `
					    <div class="vehicle-popup">
					        <div class="popup-header ${isLive ? 'live-update' : 'last-known'}">
					            ${isLive ? 'Live Update' : 'Last Known Position'}
					        </div>
					        <div class="popup-content">
					            <p><span class="popup-label">Device ID:</span> ${deviceId}</p>
					            <p><span class="popup-label">Timestamp:</span> ${timestamp}</p>
					            <p><span class="popup-label">Speed:</span> ${speed} km/h</p>
					            <p>
					                <span class="popup-label">Status:</span> 
					                <span class="status-indicator ${
					                    (ignition === 'IGoff' && (vehicleStatus || '').toUpperCase() === 'PARKED') 
					                    ? 'status-parked' 
					                    : 'status-running'
					                }">
					                    ${vehicleStatus}
					                </span>
					            </p>
					            <p>
					                <span class="popup-label">Ignition:</span> 
					                <span class="${ignition === 'IGon' ? 'ignition-on' : 'ignition-off'}">
					                    ${ignition === 'IGon' ? 'ON' : 'OFF'}
					                </span>
					            </p>
					            ${vehicle.address ? `
					                <p>
					                    <span class="popup-label">Address:</span>
					                    <span class="address">${vehicle.address}</span>
					                </p>
					            ` : ''}
					            <div style="margin-top: 10px; text-align: center;">
					                <button style="padding: 5px 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;" 
					                        onclick="navigateToReplay('${encodeURIComponent(vehicle.deviceId)}')">
					                    Playback
					                </button>
					                <button style="padding: 5px 10px; background-color: red; color: white; border: none; border-radius: 5px; cursor: pointer;" 
					                        onclick="openSideTab()">Live</button>
											
											
											<button style="padding: 5px 10px; background-color: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer;"
											    onclick="fetchVehicleDetails(this.getAttribute('data-deviceid'))"
											    data-deviceid="${deviceId}">
											    Details
											</button>


					            </div>
					        </div>
					    </div>
					`;


		        if (this.markers[deviceId]) {
		            this.markers[deviceId]
		                .setLatLng([latitude, longitude])
		                .setIcon(L.divIcon({
		                    className: 'custom-icon',
		                    html: markerHtml,
		                    iconSize: [38, 38],
		                    iconAnchor: [19, 19],
		                    popupAnchor: [0, -19],
		                }))
		                .bindPopup(popupContent);
		        } else {
		            const marker = L.marker([latitude, longitude], {
		                icon: L.divIcon({
		                    className: 'custom-icon',
		                    html: markerHtml,
		                    iconSize: [38, 38],
		                    iconAnchor: [19, 19],
		                    popupAnchor: [0, -19],
		                }),
		            }).bindPopup(popupContent).addTo(this.map);

		            this.markers[deviceId] = marker;
		        }

		        // Check for parking alert condition
		        if (isLive && ignition === 'IGoff' && (vehicleStatus || '').toUpperCase() === 'PARKED') {
		            this.showParkingAlert(vehicle);
		        }

		        this.deviceLastUpdate[deviceId] = Date.now();
		        if (isLive) {
		            this.liveDevices.add(deviceId);
		        }
		    }

		    getVehicleIcon(course, ignition, vehicleStatus) {
		        const basePath = '/THINTURE_IMAGE/car';
		        let color = 'red';
		        
		        const normalizedStatus = (vehicleStatus || '').toUpperCase();
		        const normalizedIgnition = (ignition || '').toUpperCase();
		        
		        if (normalizedStatus === 'PARKED' && normalizedIgnition === 'IGOFF') {
		            color = 'orange';
		        } else if (normalizedIgnition === 'IGON' || normalizedStatus === 'RUNNING') {
		            color = 'green';
		        }
		        
		        const adjustedCourse = ((parseFloat(course) % 360) + 360) % 360;
		        const imagePath = `${basePath}/${color}/car0.png`;
		        
		        return {
		            path: imagePath,
		            color: color,
		            rotation: adjustedCourse,
		        };
		    }
			
			
			
			
			
			
			

		    loadLastKnownPositions() {
		        console.log('Loading last known positions...');
		        this.fetchAndUpdateVehicleData('/api/vehicles/last-known', false);
		    }
		    
			fetchAndUpdateVehicleData(url, isLive = false) {
			    fetch(url)
			        .then(response => {
			            if (!response.ok) {
			                console.error(`API call failed with status ${response.status}`);
			                throw new Error(`Failed to fetch data: ${response.statusText}`);
			            }
			            return response.json();
			        })
			        .then(data => {
			            console.log("Data received from API:", data);
			            if (Array.isArray(data) && data.length > 0) {
			                data.forEach(vehicle => this.createOrUpdateMarker(vehicle, isLive));
			            } else if (typeof data === 'object' && data !== null) {
			                this.createOrUpdateMarker(data, isLive);
			            } else {
			                console.warn('No data received for vehicles.');
			            }
			        })
			        .catch(error => console.error('Error fetching vehicle data:', error));
			}


			
			
			
			
		    pollOfflineDevices() {
		        setInterval(() => {
		            console.log('Fetching offline vehicles...');
		            this.fetchAndUpdateVehicleData('/api/vehicles/last-known', false);
		        }, 30000);
		    }

		    checkInactiveDevices() {
		        setInterval(() => {
		            const now = Date.now();
		            this.liveDevices.forEach(deviceId => {
		                if (now - this.deviceLastUpdate[deviceId] > this.inactivityThreshold) {
		                    console.log('Device became inactive:', deviceId);
		                    this.liveDevices.delete(deviceId);
		                    this.fetchAndUpdateVehicleData(`/api/vehicle/latest-location/${deviceId}`, false);
		                }
		            });
		        }, this.inactivityThreshold);
		    }
			
			

		    initWebSocket() {
		        const socket = new SockJS('/gs-guide-websocket');
		        const stompClient = Stomp.over(socket);

		        stompClient.connect({}, () => {
		            console.log('WebSocket connected.');
		            stompClient.subscribe('/topic/location-updates', (message) => {
		                try {
		                    const vehicleData = JSON.parse(message.body);
		                    const standardizedData = {
		                        ...vehicleData,
		                        vehicleStatus: vehicleData.vehicleStatus || vehicleData.VehicleStatus
		                    };
		                    this.createOrUpdateMarker(standardizedData, true);
		                } catch (error) {
		                    console.error('Error processing WebSocket message:', error);
		                    console.error('Message body:', message.body);
		                }
		            });
		        }, (error) => {
		            console.error('WebSocket connection error:', error);
		            setTimeout(() => this.initWebSocket(), 5000);
		        });
		    }
		}

        // Initialize the VehicleTracker when the page is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new VehicleTracker('map');
        });
		
		
		
		
		
    </script>
	
	
	
	<script>
		document.addEventListener("DOMContentLoaded", function () {
		        const tableBody = document.getElementById("trackerTableBody");
		        const toggleButton = document.getElementById("toggleButton");
		        const sidebar = document.getElementById("sidebar");
		        const searchBar = document.getElementById("searchBar");
		        let activeRow = null;

		        // Function to format timestamp
		        function formatTimestamp(timestamp) {
		            if (!timestamp) return "N/A";
		            const date = new Date(timestamp);
		            const now = new Date();
		            const diffMinutes = Math.floor((now - date) / (1000 * 60));

		            if (diffMinutes < 1) return "Just now";
		            if (diffMinutes < 60) return `${diffMinutes} min ago`;
		            if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)} hours ago`;
		            return date.toLocaleString();
		        }

		        // Function to fetch and populate the tracker table
		        function fetchAndPopulateTrackerTable() {
		            fetch("/api/vehicle/last/latests-locations/all")
		                .then(response => {
		                    if (!response.ok) {
		                        throw new Error("Failed to fetch vehicle locations");
		                    }
		                    return response.json();
		                })
		                .then(data => {
		                    if (Array.isArray(data) && data.length > 0) {
		                        populateTable(data);
		                        startAutoRefresh();
		                    } else {
		                        showError("No vehicles found");
		                    }
		                })
		                .catch(error => {
		                    console.error("Error fetching vehicle locations:", error);
		                    showError("Failed to load vehicle data");
		                });
		        }

	        // Function to fetch and populate the tracker table
	        function fetchAndPopulateTrackerTable() {
	            fetch("/api/vehicle/last/latests-locations/all")
	                .then(response => {
	                    if (!response.ok) {
	                        throw new Error("Failed to fetch vehicle locations");
	                    }
	                    return response.json();
	                })
	                .then(data => {
	                    if (Array.isArray(data) && data.length > 0) {
	                        populateTable(data);
	                        startAutoRefresh();
	                    } else {
	                        showError("No vehicles found");
	                    }
	                })
	                .catch(error => {
	                    console.error("Error fetching vehicle locations:", error);
	                    showError("Failed to load vehicle data");
	                });
	        }

	        // Function to show error message
	        function showError(message) {
	            tableBody.innerHTML = `
	                <tr>
	                    <td colspan="4" class="error">
	                        <div class="error-message">
	                            <span>${message}</span>
	                           <button class="trybutton" onclick="fetchAndPopulateTrackerTable()">Retry</button>
	                        </div>
	                    </td>
	                </tr>
	            `;
	        }
			
			// Helper function to determine status class, text, and trigger notifications
			function getStatusInfo(vehicle) {
			    const ignition = vehicle.ignition?.toLowerCase();
			    const status = vehicle.vehicleStatus?.toUpperCase();
			    const deviceId = vehicle.deviceId || "Unknown"; // Extract deviceId from vehicle

			    let statusInfo;

			    if (ignition === "igon") {
			        statusInfo = { class: "status-on", text: "Running", icon: "🚗" };
			        showNotification("Vehicle Status", "The vehicle is Running", "🚗", deviceId);
			    } else if (status === "PARKED") {
			        statusInfo = { class: "status-parked", text: "Parked", icon: "🅿️" };
			        showNotification("Vehicle Status", "The vehicle is Parked", "🅿️", deviceId);
					
			    } else if (ignition === "igoff") {
			        statusInfo = { class: "status-off", text: "Stopped", icon: "⭕" };
			    } else {
			        statusInfo = { class: "status-unknown", text: "Unknown", icon: "❓" };
			    }

			    return statusInfo;
			}


			// Function to show notifications
			

			   

			// Function to populate the table with data and trigger notifications
			function populateTable(data) {
			    tableBody.innerHTML = "";
			    data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(vehicle => {
			        const statusInfo = getStatusInfo(vehicle);
			        const row = document.createElement("tr");

			        row.innerHTML = `
			            <td class="${statusInfo.class}">
			                <span class="status-icon">${statusInfo.icon}</span>
			                ${statusInfo.text}
			            </td>
			            <td>${vehicle.deviceId || "N/A"}</td>
			            <td data-timestamp="${vehicle.timestamp}">${formatTimestamp(vehicle.timestamp)}</td>
			            <td class="replay-cell">
			                <button class="replay-button" title="View Route History" onclick="openReplayPage('${vehicle.deviceId}', '${vehicle.startTime}', '${vehicle.endTime}')">
			                    Replay
			                </button>
			            </td>
			        `;

			        // Row click event: Highlight table row and zoom to marker
			        row.addEventListener("click", () => {
			            if (activeRow) activeRow.classList.remove("active-row"); // Remove highlight from previous row
			            row.classList.add("active-row");
			            activeRow = row;

			            zoomToVehicle(vehicle.deviceId, vehicle.latitude, vehicle.longitude);
			        });

			        row.style.cursor = "pointer";
			        tableBody.appendChild(row);
			    });
			}

			// Function to zoom in on the correct vehicle marker and highlight it
			function zoomToVehicle(deviceId, latitude, longitude) {
			    if (!latitude || !longitude) {
			        console.warn(`Invalid coordinates for Device ID: ${deviceId}`);
			        return;
			    }
				function highlightMarker(deviceId) {
				        if (window.vehicleTracker && window.vehicleTracker.markers[deviceId]) {
				            const marker = window.vehicleTracker.markers[deviceId];
				            marker.openPopup();
				            if (marker._icon) {
				                marker._icon.classList.add('highlight-marker');
				                setTimeout(() => marker._icon.classList.remove('highlight-marker'), 1000);
				            }
				        }
				    }

			    const vehicleTracker = window.vehicleTracker;
			    if (!vehicleTracker || !vehicleTracker.map || !vehicleTracker.markers) {
			        console.error("Vehicle tracker or map object not initialized!");
			        return;
			    }

			    // Reset all markers to default icon
			    Object.keys(vehicleTracker.markers).forEach(id => {
			        const prevMarker = vehicleTracker.markers[id];
			        if (prevMarker) {
			            prevMarker.setIcon(L.divIcon({
			                className: 'custom-icon',
			                html: `<img src="/THINTURE_IMAGE/car/car_default.png" style="width: 35px; height: 35px;">`,
			                iconSize: [35, 35],
			                iconAnchor: [17, 17]
			            }));
			        }
			    });

			    // Highlight and zoom in on the selected marker
			    const marker = vehicleTracker.markers[deviceId];
			    if (marker) {
			        marker.setIcon(L.divIcon({
			            className: 'custom-icon',
			            html: `<img src="/THINTURE_IMAGE/car/car_icon1.png" style="width: 50px; height: 50px;">`,
			            iconSize: [50, 50],
			            iconAnchor: [25, 25]
			        }));

			        marker.openPopup(); // Show the popup
			        vehicleTracker.map.setView([latitude, longitude], 18, { animate: true }); // Smooth zoom-in
			    } else {
			        console.warn(`Marker not found for deviceId: ${deviceId}`);
			    }
			}
			

			function showNotification(title, message, icon, deviceId) {
			    // Create notification container
			    const notification = document.createElement("div");
			    notification.classList.add("notifications");

			    // Add notification content
			    notification.innerHTML = `
			        <div class="notification-icon">${icon}</div>
			        <div class="notification-content">
			            <h4>${title}</h4>
			            <p>${message}</p>
			            <small>Device ID: ${deviceId || "Unknown"}</small>
			        </div>
			    `;

			    // Append to the body
			    document.body.appendChild(notification);

			    // Animate notification twice
			    setTimeout(() => {
			        notification.classList.add("animate");
			    }, 100); // First animation starts
			    setTimeout(() => {
			        notification.classList.remove("animate");
			        setTimeout(() => {
			            notification.classList.add("animate");
			        }, 100); // Second animation starts
			    }, 2000); // Delay before repeating the animation

			    // Automatically remove notification after both animations
			    const autoRemoveTimeout = setTimeout(() => {
			        notification.remove();
			    }, 4000);

			    // Hide notification on click
			    notification.addEventListener("click", () => {
			        clearTimeout(autoRemoveTimeout); // Cancel automatic removal
			        notification.remove();
			    });
			}



			// Call the fetch function to populate data and trigger notifications
			document.addEventListener("DOMContentLoaded", fetchAndPopulateTrackerTable);


	        // Toggle button for the sidebar
	        if (toggleButton) {
	            toggleButton.addEventListener("click", e => {
	                e.preventDefault();
	                e.stopPropagation();
	                sidebar.classList.toggle("active");
	                toggleButton.classList.toggle("active");
	            });
	        }

	        // Close sidebar when clicking outside
	        document.addEventListener("click", function (event) {
	            if (!sidebar.contains(event.target) &&
	                !toggleButton.contains(event.target) &&
	                sidebar.classList.contains("active")) {
	                sidebar.classList.remove("active");
	                toggleButton.classList.remove("active");
	            }
	        });

	        // Add search functionality
	        if (searchBar) {
	            searchBar.addEventListener("input", function () {
	                const searchText = this.value.trim().toLowerCase();
	                const rows = tableBody.querySelectorAll("tr");

	                rows.forEach(row => {
	                    const deviceId = row.children[1].textContent.toLowerCase();
	                    const status = row.children[0].textContent.toLowerCase();

	                    if (deviceId.includes(searchText) || status.includes(searchText)) {
	                        row.style.display = "";
	                    } else {
	                        row.style.display = "none";
	                    }
	                });
	            });
	        }

	        // Start auto-refresh
	        function startAutoRefresh() {
	            setInterval(() => {
	                fetchAndPopulateTrackerTable();
	            }, 70000);
	        }

	        // Initialize
	        fetchAndPopulateTrackerTable();
	    });
	</script>
<script>
	function navigateToReplay(deviceId) {
	    console.log("Navigating with Device ID:", deviceId);
	    if (!deviceId) {
	        alert("Device ID is required to navigate to the replay page.");
	        return;
	    }
	    window.location.href = `/playback?deviceId=${encodeURIComponent(deviceId)}`;
	}

	
	
	const vehicle1 = { ignition: "igon", vehicleStatus: "running" };
	const vehicle2 = { ignition: "igoff", vehicleStatus: "PARKED" };

	getStatusInfo(vehicle1); // Notification: Running
	getStatusInfo(vehicle2); // Notification: Parked
	


		document.addEventListener("DOMContentLoaded", function () {
	    fetch("/api/details")
	        .then(response => response.json())
	        .then(data => {
	            console.log("✅ Received Data:", data);

	            if (!data || data.length === 0) {
	                console.error("❌ No vehicles found");
	                document.getElementById("vehiclesTable").innerHTML = "<tr><td colspan='8'>No Data Available</td></tr>";
	                return;
	            }

	            let tableContent = "";
	            data.forEach(vehicle => {
	                tableContent += `
	                    <tr>
	                        <td>${vehicle.deviceID || "N/A"}</td>
	                        <td>${vehicle.vehicleNumber || "N/A"}</td>
	                        <td>${vehicle.imei || "N/A"}</td>
	                        <td>${vehicle.engineNumber || "N/A"}</td>
	                        <td>${vehicle.model || "N/A"}</td>
	                        <td>${vehicle.ownerName || "N/A"}</td>
	                        <td>${vehicle.vehicleType || "N/A"}</td>
	                        <td>
	                            <button onclick="fetchVehicleDetails('${vehicle.deviceID}')">Details</button>
	                        </td>
	                    </tr>`;
	            });

	            document.getElementById("vehiclesTable").innerHTML = tableContent;
	        })
	        .catch(error => console.error("🚨 Error fetching vehicle list:", error));
	});

	// ✅ Function to fetch vehicle details and show in popup
	// ✅ Function to fetch vehicle details and show in popup
	function fetchVehicleDetails(deviceID) {
	    if (!deviceID) {
	        console.error("❌ Device ID is missing!");
	        alert("❌ No Device ID found!");
	        return;
	    }

	    console.log("🚀 Fetching details for Device ID:", deviceID);

	    fetch(`/api/details/${deviceID}`)
	        .then(response => {
	            console.log("📡 Response Status:", response.status);
	            if (!response.ok) {
	                throw new Error("❌ Server returned error " + response.status);
	            }
	            return response.json();
	        })
	        .then(vehicle => {
	            console.log("📡 Vehicle Details Received:", vehicle);

	            if (!vehicle || Object.keys(vehicle).length === 0) {
	                alert("❌ No data found for this vehicle!");
	                return;
	            }

	            // ✅ Populate Table Data Inside Popup
	            let tableContent = `
	                <tr><td><strong>Device ID:</strong></td><td>${vehicle.deviceID || "N/A"}</td></tr>
	                <tr><td><strong>Vehicle Number:</strong></td><td>${vehicle.vehicleNumber || "N/A"}</td></tr>
	                <tr><td><strong>IMEI:</strong></td><td>${vehicle.imei || "N/A"}</td></tr>
	                <tr><td><strong>Engine Number:</strong></td><td>${vehicle.engineNumber || "N/A"}</td></tr>
	                <tr><td><strong>Model:</strong></td><td>${vehicle.model || "N/A"}</td></tr>
	                <tr><td><strong>Owner Name:</strong></td><td>${vehicle.ownerName || "N/A"}</td></tr>
	                <tr><td><strong>Vehicle Type:</strong></td><td>${vehicle.vehicleType || "N/A"}</td></tr>
	            `;

	            document.getElementById("vehicleDetailsTable").innerHTML = tableContent;

	            // ✅ Show Modal
	            document.getElementById("vehicleDetailsModal").style.display = "block";
	            console.log("✅ Table Populated & Modal Opened!");
	        })
	        .catch(error => {
	            console.error("🚨 Error fetching vehicle details:", error);
	            alert("⚠️ Error fetching data. Check console for details.");
	        });
	}

	// ✅ Function to Close Popup
	function closeVehicleDetails() {
	  const modal = document.getElementById("vehicleDetailsModal");
	  if (modal) {
	    modal.style.display = "none";
	  }
	}


	
	function showPopup() {
	    document.getElementById("detailsPopup").style.display = "block";
	    document.getElementById("popupOverlay").style.display = "block";
	}

	function closePopup() {
	    document.getElementById("detailsPopup").style.display = "none";
	    document.getElementById("popupOverlay").style.display = "none";
	}

	// Modify this in fetchVehicleDetails function
	document.getElementById("vehicleDetailsModal").style.display = "block";




</script>
	
	
	
</body>
</html>